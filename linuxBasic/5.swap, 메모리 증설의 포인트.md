# 5. swap, 메모리 증설의 포인트

## Swap 영역
- swap 영역은 물리메모리가 부족할 경우를 대비해서 만들어 놓은 영역이다.
- 디스크의 일부분을 메모리처럼 사용하기 위해 만들어 놓은 공간이기 때문에 메모리에 비해 접근과 처리속도가 떨어진다.
- 아무리 적은 영역이라도 swap영역을 사용했다는것 자체가 시스템에 메모리와 관련해 문제가 있을수 있다는 의미이다.

### swap 영역 확인하기
- `/proc/<pid>` : pid를 가진 프로세스가 자신과 관련된 정보를 저장하고 있는 디렉터리
    - `/proc/<pid>/smaps`
        - 특정 프로세스(pid)가 사용하고 있는 메모리 정보를 저장하고 있는 파일
        - **Swap**항목 : 프로세스가 사용하고 있는 메모리 영역중 swap영역이 있는지 없는지 확인 할 수 있다.
    - `/proc/<pid>/status` 
        - **VmSwap** : 특정 프로세스가 사용하는 전체 swap 영역에 대한 정보

- `smem` 유틸리티 
    - /proc/<pid>의 내용을 바탕으로 전체 프로세스 별로 사용중인 메모리 현황을 보여준다.
    
## 버디 시스템
- 커널은 버디 시스템을 통해서 프로세스에 메모리를 할당한다.
- 버디시스템은 물리메모리를 연속된 메모리 영역으로 관리한다.
    - 연속 한개의 페이지 크리별 버디, 연속 2개의 페이지 크기별 버디등.
- `/proc/buddyinfo` : 버디 시스템의 현재 상황을 볼 수 있다.

## 메모리 재할당 과정
커널에서의 메모리 재할당을 주로 두가지 로직으로 처리한다.
1. 커널이 사용하는 캐시 메모리 재할당  
    - 프로세스가 사용하고 있지 않는 가용한 메모리는 주로 커널에서 캐시 용도로 사용한다. 예) Page Cache, Buffer Cache, inode cache, dentry cache등  
    - 메모리를 캐시용으로 사용하면 시스템성능이 전반적으로 향상된다.
    - 프로세스가 메모리를 필요로 할때 사용할 메모리가 부족해질 수 있다.이때 메모리 재할당이 일어나며 커널은 캐시 용도로 사용하던 메모리를 사용 해제하고 가용 메모리 영역으로 돌린 후 프로세스가 사용할 수 있도록 재할당 한다.
    - 시스템 운영중 자연스럽게 발생
2. swap을 사용하는 재할당
    - 캐시용도의 메모리를 해제하고도 더이상 프로세스에 할당해줄 메모리가 없다면 swap을 사용
    - 프로세스가 사용하는 메모리 중 Inactive 리스트에 있는 메모리를 골라서 swap 영역으로 이동시킨다.
    - 해당 메모리 영역을 해제하고 다른 프로세스에 할당한다.
    - 프로세스가 해당 메모리 영역을 참조하면 다시 swap영역에서 불러들이는데, 메모리를 swap영역으로 쓰거나 읽는 작업이 디스크에서 일어나기 때문에 I/O를 일으키고 이 과정에서 시스템의 성능이 저하된다..
    
## vm.swappiness와 vm.vfs_cache_pressure
- `vm.swappiness` 
    - 메모리가 부족해서 커널이 메모리를 재할당할 때 캐시 메모리를 재할당할 것인지 아니면 swap을 사용할 것인지의 비율 조절값
    - 이 값이 커질수록 swap 영역을 사용하고, 작을수록 캐시 메모리를 재할당 한다.
- `vm.vfs_cache_pressure` 
    - 캐시를 재할당할 경우 PageCache를 더 많이 재할당할지 아니면 디렉터리나 inode캐시를 더 많이 재할당할지 결정
    

## 메모리 증설의 포인트
#### 시스템이 swap을 사용한다면 메모리를 증설해야 할까?
- 메모리 누수가 원인이라면 메모리를 증설한다고 해도 결국 swap영역을 사용하게 된다.
- 메모리의 사용량이 선형적으로 증가하는 경우에는 메모리 누수를 의심해 볼 수 있다.
    - `pmap`등의 명령을 이용해 해당 프로세스가 사용하는 힙메모리 영역이 어떻게 변화하는지 살펴본다.
- 순간적인 메모리 사용량 폭증일 경우에는 안정적인 서비스를 위해 사용한 메모리의 최대치를 계산해서 메모리를 증설하면 도움이 된다.
- 서비스에 큰 영향을 주는 응답속도가 아니라면 swap을 사용하는것으로 방어하는것도 하나의 방법

### gdb를 이용해 메모리 누수 잡기
- 메모리 누수가 의심될때 `gdb`와 같은 디버깅 도구를 사용할 수 있다.
- 힙 메모리의 영역에 메모리 덤프를 생성하고 실제 메모리의 내용을 살펴보면 어떤 로직에서 사용한 메모리 영역이 해제되지 않았는지 확인 할 수 있다.